---
import { apps } from '../config/apps';
import { saas } from '../config/saas';
import { getLangFromLocals, useTranslations } from '../i18n/utils';

const lang = getLangFromLocals(Astro.locals);
const t = useTranslations(lang);
---

<div class="floating-header-container">
  <header class="taskbar">
    <a href="/" class="taskbar-item logo-item" aria-label="Home">
      <img src="https://hosted.inled.es/INLED_simple-removebg-preview.png" alt="Inled Logo">
    </a>

    <div class="taskbar-divider"></div>

    <div class="apps-grid-container">
      <button class="taskbar-item apps-grid-toggle" aria-label="Apps Menu">
        <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-layout-grid"><rect width="7" height="7" x="3" y="3" rx="1"/><rect width="7" height="7" x="14" y="3" rx="1"/><rect width="7" height="7" x="14" y="14" rx="1"/><rect width="7" height="7" x="3" y="14" rx="1"/></svg>
      </button>
      
      <div class="apps-grid-overlay" data-lenis-prevent>
        <div class="apps-grid-content">
          <div class="grid-section">
            <h3>{t('grid.saas')}</h3>
            <div class="grid-items">
              {saas.map((item) => (
                <a href={item.link} class="grid-item">
                  <div class="grid-item-icon">
                    <img src={item.icon} alt={item.name} loading="lazy" />
                  </div>
                  <span class="grid-item-name">{item.name}</span>
                </a>
              ))}
            </div>
          </div>

          <div class="grid-divider"></div>

          <div class="grid-section">
            <h3>{t('grid.apps')}</h3>
            <div class="grid-items">
              {apps.map((app) => (
                <a href={app.link} class="grid-item">
                  <div class="grid-item-icon">
                    <img src={app.icon} alt={app.name} loading="lazy" />
                  </div>
                  <span class="grid-item-name">{app.name}</span>
                </a>
              ))}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="taskbar-divider"></div>

    <div class="lang-selector-container">
        <button class="taskbar-item lang-toggle" aria-label="Change Language">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-languages"><path d="m5 8 6 6"/><path d="m4 14 6-6 2-3"/><path d="M2 5h12"/><path d="M7 2h1"/><path d="m22 22-5-10-5 10"/><path d="M14 18h6"/></svg>
        </button>
        <div class="lang-menu">
            <button class={`lang-btn ${lang === 'es' ? 'active' : ''}`} data-lang="es">Espa√±ol</button>
            <button class={`lang-btn ${lang === 'en' ? 'active' : ''}`} data-lang="en">English</button>
        </div>
    </div>

    <a href="/contacto" class="taskbar-item contact-item" aria-label={t('nav.contact')}>
      <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-mail"><rect width="20" height="16" x="2" y="4" rx="2"/><path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"/></svg>
    </a>
  </header>
</div>

<style>
  .floating-header-container {
    position: fixed;
    top: 1.5rem;
    left: 0;
    right: 0;
    display: flex;
    justify-content: center;
    z-index: 2000;
    pointer-events: none;
  }

  .taskbar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: rgba(20, 20, 25, 0.7);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    pointer-events: auto;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .taskbar:hover {
    background: rgba(25, 25, 30, 0.85);
    border-color: rgba(255, 255, 255, 0.25);
    transform: scale(1.02);
  }

  .taskbar-item {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border-radius: 12px;
    color: rgba(255, 255, 255, 0.85);
    background: transparent;
    border: none;
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    text-decoration: none;
    position: relative;
  }

  .taskbar-item:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
    transform: translateY(-4px);
  }

  .taskbar-item svg {
    transition: transform 0.2s ease;
  }

  .taskbar-item:hover svg {
    transform: scale(1.1);
  }

  .logo-item {
    padding: 6px;
  }

  .logo-item img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .taskbar-divider {
    width: 1px;
    height: 24px;
    background: rgba(255, 255, 255, 0.15);
    margin: 0 4px;
  }

  /* Apps Grid Overlay */
  .apps-grid-container {
    position: relative;
  }

  .apps-grid-overlay {
    position: absolute;
    top: calc(100% + 1rem);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(20, 20, 25, 0.98);
    backdrop-filter: blur(25px);
    -webkit-backdrop-filter: blur(25px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 24px;
    width: 380px;
    max-height: calc(100vh - 120px);
    overflow-y: auto;
    overscroll-behavior: contain;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
    z-index: 2001;
    scrollbar-width: none;
  }

  .apps-grid-overlay::-webkit-scrollbar {
    display: none;
  }

  .apps-grid-container.open .apps-grid-overlay {
    opacity: 1;
    visibility: visible;
    transform: translateX(-50%) translateY(0);
  }

  .apps-grid-content {
    padding: 1.5rem;
    padding-bottom: 3rem;
  }

  .grid-section h3 {
    color: rgba(255, 255, 255, 0.5);
    font-size: 0.7rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 1rem;
  }

  .grid-items {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: 0.5rem;
  }

  .grid-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 0.25rem;
    border-radius: 16px;
    text-decoration: none;
    transition: all 0.2s ease;
    text-align: center;
  }

  .grid-item:hover {
    background: rgba(255, 255, 255, 0.08);
    transform: translateY(-2px);
  }

  .grid-item-icon {
    width: 44px;
    height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 10px;
    overflow: hidden;
    flex-shrink: 0;
  }

  .grid-item-icon img {
    width: 100%;
    height: 100%;
    object-fit: contain;
  }

  .grid-item-name {
    color: white;
    font-size: 0.7rem;
    font-weight: 500;
    width: 100%;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }

  .grid-divider {
    height: 1px;
    background: rgba(255, 255, 255, 0.1);
    margin: 1.25rem 0;
  }

  /* Lang Selector */
  .lang-selector-container {
    position: relative;
  }

  .lang-menu {
    position: absolute;
    top: calc(100% + 1rem);
    left: 50%;
    transform: translateX(-50%);
    background: rgba(25, 25, 30, 0.95);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255, 255, 255, 0.15);
    border-radius: 12px;
    padding: 0.5rem;
    min-width: 120px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.2s ease;
    display: flex;
    flex-direction: column;
    gap: 2px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  }

  .lang-selector-container.open .lang-menu {
    opacity: 1;
    visibility: visible;
  }

  .lang-btn {
    background: transparent;
    border: none;
    color: rgba(255, 255, 255, 0.7);
    padding: 0.6rem 1rem;
    border-radius: 8px;
    font-size: 0.85rem;
    cursor: pointer;
    text-align: left;
    transition: all 0.2s ease;
  }

  .lang-btn:hover {
    background: rgba(255, 255, 255, 0.1);
    color: #fff;
  }

  .lang-btn.active {
    background: rgba(255, 255, 255, 0.15);
    color: #fff;
    font-weight: 600;
  }

  @media (max-width: 480px) {
    .taskbar {
        gap: 0.25rem;
    }
    .apps-grid-overlay {
        width: 300px;
        grid-template-columns: repeat(2, 1fr);
    }
    .grid-items {
        grid-template-columns: repeat(3, 1fr);
    }
  }
</style>

<script>
  const appsGridContainer = document.querySelector('.apps-grid-container');
  const appsGridToggle = document.querySelector('.apps-grid-toggle');
  const langSelectorContainer = document.querySelector('.lang-selector-container');
  const langToggle = document.querySelector('.lang-toggle');
  const langBtns = document.querySelectorAll('.lang-btn');

  // Apps Menu Toggle
  appsGridToggle?.addEventListener('click', (e) => {
    e.stopPropagation();
    langSelectorContainer?.classList.remove('open');
    appsGridContainer?.classList.toggle('open');
  });

  // Lang Menu Toggle
  langToggle?.addEventListener('click', (e) => {
    e.stopPropagation();
    appsGridContainer?.classList.remove('open');
    langSelectorContainer?.classList.toggle('open');
  });

  // Language selector logic
  function setLanguage(lang: string) {
    document.cookie = `preferred-lang=${lang}; path=/; max-age=${60*60*24*365}; SameSite=Lax`;
    localStorage.setItem('preferred-lang', lang);
    window.location.reload();
  }

  langBtns.forEach(btn => {
    btn.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const lang = target.getAttribute('data-lang');
      if (lang) setLanguage(lang);
    });
  });

  // Close when clicking outside
  document.addEventListener('click', (e) => {
    const target = e.target as HTMLElement;
    
    if (!target.closest('.apps-grid-container')) {
      appsGridContainer?.classList.remove('open');
    }
    if (!target.closest('.lang-selector-container')) {
      langSelectorContainer?.classList.remove('open');
    }
  });
</script>
